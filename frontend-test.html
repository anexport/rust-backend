<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Equipment Rental - Test App</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        body { background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .nav { display: flex; gap: 10px; }
        .nav button { background: #e0e0e0; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .nav button:hover { background: #d0d0d0; }
        .nav button.active { background: #2563eb; color: white; }
        .card { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #1d4ed8; }
        .btn.secondary { background: #64748b; }
        .btn.danger { background: #dc2626; }
        .hidden { display: none !important; }
        .equipment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .equipment-card { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .equipment-card img { width: 100%; height: 180px; object-fit: cover; background: #e5e7eb; }
        .equipment-card .content { padding: 15px; }
        .equipment-card h3 { margin-bottom: 5px; }
        .equipment-card .price { color: #2563eb; font-weight: bold; font-size: 18px; }
        .equipment-card .meta { color: #64748b; font-size: 14px; margin-top: 5px; }
        .equipment-card .actions { padding: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; }
        .equipment-card .actions button { flex: 1; padding: 8px; }
        .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px; }
        .tabs button { background: none; border: none; padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tabs button.active { border-bottom-color: #2563eb; color: #2563eb; }
        .message-thread { border: 1px solid #e5e7eb; border-radius: 8px; height: 400px; display: flex; flex-direction: column; }
        .messages { flex: 1; overflow-y: auto; padding: 15px; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 8px; max-width: 70%; }
        .message.sent { background: #2563eb; color: white; margin-left: auto; }
        .message.received { background: #e5e7eb; }
        .message-input { padding: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; }
        .message-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .user-profile { display: flex; gap: 20px; align-items: flex-start; }
        .user-avatar { width: 80px; height: 80px; border-radius: 50%; background: #e5e7eb; }
        .user-info h2 { margin-bottom: 10px; }
        .user-stats { display: flex; gap: 30px; margin-top: 15px; }
        .stat { text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #2563eb; }
        .stat-label { font-size: 14px; color: #64748b; }
        .rating-stars { color: #fbbf24; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; z-index: 1000; }
        .toast.success { background: #22c55e; }
        .toast.error { background: #dc2626; }
        .conversation-list { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .conversation-item { padding: 15px; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
        .conversation-item:hover { background: #f9fafb; }
        .conversation-item.active { background: #eff6ff; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; }
        .modal h2 { margin-bottom: 20px; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .rating-input { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .rating-input button { background: none; border: none; font-size: 32px; cursor: pointer; }
        .rating-input button.selected { color: #fbbf24; }
        .review-list { margin-top: 20px; }
        .review-item { background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Equipment Rental P2P</h1>
            <div class="nav">
                <button onclick="showView('equipment')" data-view="equipment">Equipment</button>
                <button onclick="showView('messages')" data-view="messages">Messages</button>
                <button onclick="showView('profile')" data-view="profile">My Profile</button>
                <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Auth View -->
        <div id="authView" class="view">
            <div class="card" style="max-width: 400px; margin: 50px auto;">
                <div class="tabs">
                    <button onclick="showAuthTab('login')" class="active">Login</button>
                    <button onclick="showAuthTab('register')">Register</button>
                </div>

                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>

                <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Username (optional)</label>
                        <input type="text" id="registerUsername" minlength="3" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Full Name (optional)</label>
                        <input type="text" id="registerFullName">
                    </div>
                    <div class="form-group">
                        <label>Password (min 12 characters)</label>
                        <input type="password" id="registerPassword" minlength="12" required>
                    </div>
                    <button type="submit" class="btn">Register</button>
                </form>
            </div>
        </div>

        <!-- Equipment View -->
        <div id="equipmentView" class="view hidden">
            <div class="card">
                <h2>Browse Equipment</h2>
                <div class="equipment-grid" id="equipmentList"></div>
            </div>

            <div id="equipmentDetail" class="card hidden">
                <button onclick="hideEquipmentDetail()" class="btn secondary">← Back</button>
                <div id="equipmentDetailContent" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Messages View -->
        <div id="messagesView" class="view hidden">
            <div style="display: flex; gap: 20px; height: 500px;">
                <div style="width: 300px;">
                    <div class="card">
                        <h3>Conversations</h3>
                        <button onclick="showNewConversationModal()" class="btn" style="width: 100%; margin-bottom: 15px;">+ New Conversation</button>
                        <div id="conversationList" class="conversation-list"></div>
                    </div>
                </div>
                <div style="flex: 1;">
                    <div class="card" style="height: 100%;">
                        <div id="selectedConversationHeader"></div>
                        <div class="message-thread">
                            <div id="messageList" class="messages"></div>
                            <div class="message-input">
                                <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
                                <button onclick="sendMessage()" class="btn">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profileView" class="view hidden">
            <div class="card">
                <h2>My Equipment</h2>
                <button onclick="showCreateEquipmentModal()" class="btn" style="margin-bottom: 20px;">+ List Equipment</button>
                <div class="equipment-grid" id="myEquipmentList"></div>
            </div>
        </div>
    </div>

    <!-- Create Equipment Modal -->
    <div id="createEquipmentModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>List New Equipment</h2>
            <form onsubmit="handleCreateEquipment(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="equipmentTitle" required minlength="3" maxlength="200">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="equipmentDescription" required minlength="10" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Daily Rate ($)</label>
                    <input type="number" id="equipmentRate" required step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Condition</label>
                    <select id="equipmentCondition" required>
                        <option value="new">New</option>
                        <option value="excellent">Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="equipmentLocation" required minlength="2" maxlength="255">
                </div>
                <div class="form-group">
                    <label>Category ID (UUID)</label>
                    <input type="text" id="equipmentCategoryId" placeholder="Use default or get from /api/categories" required>
                </div>
                <div class="form-group">
                    <label>Photo URL (optional)</label>
                    <input type="url" id="equipmentPhotoUrl" placeholder="https://example.com/photo.jpg">
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeModal('createEquipmentModal')" class="btn secondary">Cancel</button>
                    <button type="submit" class="btn">Create Listing</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Conversation Modal -->
    <div id="newConversationModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>Start New Conversation</h2>
            <div class="form-group">
                <label>User ID to chat with</label>
                <input type="text" id="newConversationUserId" placeholder="Enter user UUID">
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeModal('newConversationModal')" class="btn secondary">Cancel</button>
                <button onclick="handleNewConversation()" class="btn">Start Chat</button>
            </div>
        </div>
    </div>

    <!-- Review Modal (placeholder for when backend endpoint exists) -->
    <div id="reviewModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>Write a Review</h2>
            <p>Review for: <span id="reviewUserName"></span></p>
            <div class="rating-input" id="ratingInput">
                <button type="button" data-rating="1" onclick="setRating(1)">★</button>
                <button type="button" data-rating="2" onclick="setRating(2)">★</button>
                <button type="button" data-rating="3" onclick="setRating(3)">★</button>
                <button type="button" data-rating="4" onclick="setRating(4)">★</button>
                <button type="button" data-rating="5" onclick="setRating(5)">★</button>
            </div>
            <div class="form-group">
                <label>Comment</label>
                <textarea id="reviewComment" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeModal('reviewModal')" class="btn secondary">Cancel</button>
                <button onclick="handleSubmitReview()" class="btn">Submit Review</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8080';
        let accessToken = localStorage.getItem('accessToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let selectedRating = 0;
        let currentRevieweeId = null;
        let currentBookingId = null;
        let selectedConversation = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (accessToken) {
                document.getElementById('authView').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                bootstrapSession();
                showView('equipment');
                loadEquipment();
            }
        });

        // API Helper
        async function api(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                throw new Error(data.message || data.error || 'Request failed');
            }
            return data;
        }

        async function bootstrapSession() {
            if (!accessToken) return;
            try {
                currentUser = await api('/api/auth/me');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } catch (_) {
                logout();
                showToast('Session expired. Please login again.', 'error');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Auth functions
        function showAuthTab(tab) {
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tabs button:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        async function handleLogin(e) {
            e.preventDefault();
            try {
                const data = await api('/api/auth/auth0/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    })
                });
                accessToken = data.access_token;
                localStorage.setItem('accessToken', accessToken);
                currentUser = await api('/api/auth/me');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('authView').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                showView('equipment');
                loadEquipment();
                showToast('Login successful!');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            try {
                const payload = {
                    email: document.getElementById('registerEmail').value,
                    password: document.getElementById('registerPassword').value
                };
                const username = document.getElementById('registerUsername').value;
                const fullName = document.getElementById('registerFullName').value;
                if (username) payload.username = username;
                if (fullName) payload.full_name = fullName;

                await api('/api/auth/auth0/signup', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showToast('Registration successful! Please login.');
                showAuthTab('login');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function logout() {
            accessToken = null;
            currentUser = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('currentUser');
            document.getElementById('authView').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.querySelectorAll('.view').forEach(v => v.id !== 'authView' && v.classList.add('hidden'));
        }

        // Navigation
        function showView(viewName) {
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav button[data-view="${viewName}"]`)?.classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${viewName}View`).classList.remove('hidden');

            if (viewName === 'equipment') loadEquipment();
            if (viewName === 'messages') loadConversations();
            if (viewName === 'profile') loadMyEquipment();
        }

        // Equipment functions
        async function loadEquipment() {
            try {
                const data = await api('/api/equipment');
                const equipment = data.items || data;
                const container = document.getElementById('equipmentList');
                container.innerHTML = equipment.map(e => `
                    <div class="equipment-card">
                        <img src="${e.photos?.[0]?.photo_url || 'https://via.placeholder.com/280x180'}" alt="${e.title}">
                        <div class="content">
                            <h3>${e.title}</h3>
                            <div class="price">$${e.daily_rate}/day</div>
                            <div class="meta">${e.condition} • ${e.location}</div>
                        </div>
                        <div class="actions">
                            <button class="btn" onclick="viewEquipment('${e.id}')">View Details</button>
                            <button class="btn secondary" onclick="startChatWithOwner('${e.owner_id}')">Message</button>
                        </div>
                    </div>
                `).join('') || '<p style="padding: 20px;">No equipment listed yet.</p>';
            } catch (err) {
                showToast('Failed to load equipment', 'error');
            }
        }

        async function viewEquipment(id) {
            try {
                const e = await api(`/api/equipment/${id}`);
                const detail = document.getElementById('equipmentDetail');
                const content = document.getElementById('equipmentDetailContent');
                detail.classList.remove('hidden');
                content.innerHTML = `
                    <div style="display: flex; gap: 30px;">
                        <img src="${e.photos?.[0]?.photo_url || 'https://via.placeholder.com/400x300'}" style="width: 400px; height: 300px; object-fit: cover; border-radius: 8px;">
                        <div style="flex: 1;">
                            <h2>${e.title}</h2>
                            <h3 style="color: #2563eb; margin: 10px 0;">$${e.daily_rate}/day</h3>
                            <p><strong>Condition:</strong> ${e.condition}</p>
                            <p><strong>Location:</strong> ${e.location}</p>
                            <p style="margin-top: 15px;">${e.description}</p>
                            <div style="margin-top: 20px;">
                                <button class="btn" onclick="startChatWithOwner('${e.owner_id}')">Message Owner</button>
                                <button class="btn secondary" onclick="showReviewModal('${e.owner_id}', null)">View Reviews</button>
                            </div>
                        </div>
                    </div>
                `;
                // Load reviews (placeholder - endpoint doesn't exist yet)
                loadReviews(id);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function hideEquipmentDetail() {
            document.getElementById('equipmentDetail').classList.add('hidden');
        }

        function loadReviews(equipmentId) {
            // Placeholder - backend endpoint for reviews doesn't exist yet
            const content = document.getElementById('equipmentDetailContent');
            content.innerHTML += `
                <div class="review-list">
                    <h3>Reviews</h3>
                    <p style="color: #64748b;">No reviews yet. Reviews endpoint coming soon.</p>
                </div>
            `;
        }

        async function loadMyEquipment() {
            try {
                const data = await api('/api/users/me/equipment');
                const equipment = data.items || data;
                const container = document.getElementById('myEquipmentList');
                container.innerHTML = equipment.map(e => `
                    <div class="equipment-card">
                        <img src="${e.photos?.[0]?.photo_url || 'https://via.placeholder.com/280x180'}" alt="${e.title}">
                        <div class="content">
                            <h3>${e.title}</h3>
                            <div class="price">$${e.daily_rate}/day</div>
                            <div class="meta">${e.is_available ? 'Available' : 'Not Available'}</div>
                        </div>
                    </div>
                `).join('') || '<p style="padding: 20px;">You haven\'t listed any equipment yet.</p>';
            } catch (err) {
                showToast('Failed to load your equipment', 'error');
            }
        }

        function showCreateEquipmentModal() {
            document.getElementById('createEquipmentModal').classList.remove('hidden');
        }

        async function handleCreateEquipment(e) {
            e.preventDefault();
            try {
                const payload = {
                    title: document.getElementById('equipmentTitle').value,
                    description: document.getElementById('equipmentDescription').value,
                    daily_rate: parseFloat(document.getElementById('equipmentRate').value),
                    condition: document.getElementById('equipmentCondition').value,
                    location: document.getElementById('equipmentLocation').value,
                    category_id: document.getElementById('equipmentCategoryId').value
                };
                const result = await api('/api/equipment', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                // Add photo if provided
                const photoUrl = document.getElementById('equipmentPhotoUrl').value;
                if (photoUrl) {
                    await api(`/api/equipment/${result.id}/photos`, {
                        method: 'POST',
                        body: JSON.stringify({ photo_url: photoUrl, is_primary: true })
                    });
                }

                closeModal('createEquipmentModal');
                e.target.reset();
                loadMyEquipment();
                showToast('Equipment listed successfully!');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // Messages functions
        async function loadConversations() {
            try {
                const data = await api('/api/conversations');
                const conversations = data.items || data;
                const container = document.getElementById('conversationList');
                if (!conversations.length) {
                    container.innerHTML = '<div style="padding: 15px;">No conversations yet.</div>';
                    return;
                }
                container.innerHTML = conversations.map(c => {
                    const otherUser = c.participants.find(p => p.id !== currentUser.id);
                    return `
                        <div class="conversation-item ${selectedConversation === c.id ? 'active' : ''}" onclick="selectConversation('${c.id}')">
                            <strong>${otherUser?.username || otherUser?.full_name || 'Unknown'}</strong>
                            <div style="color: #64748b; font-size: 14px;">${c.last_message?.content || 'No messages'}</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                showToast('Failed to load conversations', 'error');
            }
        }

        async function selectConversation(id) {
            selectedConversation = id;
            loadConversations(); // Refresh to show active state
            try {
                const c = await api(`/api/conversations/${id}`);
                const otherUser = c.participants.find(p => p.id !== currentUser.id);
                document.getElementById('selectedConversationHeader').innerHTML = `
                    <div style="padding: 15px; border-bottom: 1px solid #e5e7eb;">
                        <strong>Chat with ${otherUser?.username || otherUser?.full_name || 'Unknown'}</strong>
                    </div>
                `;
                await loadMessages(id);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function loadMessages(conversationId) {
            try {
                const data = await api(`/api/conversations/${conversationId}/messages`);
                const messages = data.items || data;
                const container = document.getElementById('messageList');
                container.innerHTML = messages.map(m => `
                    <div class="message ${m.sender_id === currentUser.id ? 'sent' : 'received'}">
                        ${m.content}
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            } catch (err) {
                showToast('Failed to load messages', 'error');
            }
        }

        async function sendMessage() {
            if (!selectedConversation) return;
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            try {
                await api(`/api/conversations/${selectedConversation}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });
                input.value = '';
                loadMessages(selectedConversation);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function showNewConversationModal() {
            document.getElementById('newConversationModal').classList.remove('hidden');
        }

        async function handleNewConversation() {
            const userId = document.getElementById('newConversationUserId').value.trim();
            if (!userId) return;

            try {
                const result = await api('/api/conversations', {
                    method: 'POST',
                    body: JSON.stringify({ participant_ids: [userId] })
                });
                closeModal('newConversationModal');
                document.getElementById('newConversationUserId').value = '';
                selectedConversation = result.id;
                loadConversations();
                selectConversation(result.id);
                showToast('Conversation started!');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function startChatWithOwner(userId) {
            try {
                const result = await api('/api/conversations', {
                    method: 'POST',
                    body: JSON.stringify({ participant_ids: [userId] })
                });
                showView('messages');
                selectedConversation = result.id;
                loadConversations();
                selectConversation(result.id);
            } catch (err) {
                // Conversation might already exist
                if (err.message.includes('already exists') || err.message.includes('duplicate')) {
                    showView('messages');
                    loadConversations();
                } else {
                    showToast(err.message, 'error');
                }
            }
        }

        // Review functions (placeholder - backend endpoint needed)
        function showReviewModal(revieweeId, bookingId) {
            currentRevieweeId = revieweeId;
            currentBookingId = bookingId;
            selectedRating = 0;
            document.querySelectorAll('#ratingInput button').forEach(b => b.classList.remove('selected'));
            document.getElementById('reviewModal').classList.remove('hidden');
        }

        function setRating(rating) {
            selectedRating = rating;
            document.querySelectorAll('#ratingInput button').forEach(b => {
                b.classList.toggle('selected', parseInt(b.dataset.rating) <= rating);
            });
        }

        async function handleSubmitReview() {
            if (selectedRating === 0) {
                showToast('Please select a rating', 'error');
                return;
            }
            // Placeholder - backend review endpoint doesn't exist yet
            showToast('Review endpoint coming soon to backend', 'error');
            closeModal('reviewModal');
        }

        // Utility functions
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>

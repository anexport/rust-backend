groups:
  - name: rust-backend
    interval: 30s
    rules:
      - alert: RustBackendHigh5xxRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            clamp_min(sum(rate(http_requests_total[5m])), 0.001)
          ) > 0.01
        for: 10m
        labels:
          severity: page
          service: rust-backend
        annotations:
          summary: "5xx rate above 1%"
          description: "5xx ratio has been above 1% for 10 minutes."

      - alert: RustBackendAuthFailuresSpike
        expr: rate(auth_failures_total[5m]) > 5
        for: 10m
        labels:
          severity: warning
          service: rust-backend
        annotations:
          summary: "Auth failure spike detected"
          description: "Auth failures have sustained >5/sec for 10 minutes."

      - alert: RustBackendHighLatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 0.75
        for: 10m
        labels:
          severity: warning
          service: rust-backend
        annotations:
          summary: "P95 latency above 750ms"
          description: "Request latency p95 has been above 750ms for 10 minutes."

      - alert: RustBackendWebSocketConnectionsDrop
        expr: ws_connections < 1
        for: 15m
        labels:
          severity: warning
          service: rust-backend
        annotations:
          summary: "No active websocket connections"
          description: "No websocket connections observed for at least 15 minutes."
